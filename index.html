<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta charset="utf-8">
	<title>Explosions Editor</title>
	<script src="expl.js"></script>
	<style type="text/css">
		body {
			font-family: sans-serif;
			font-size: 1.2em;
			margin: 0;
		}
		canvas {
			background: #000;
			width: 50vw;
			float: left;
		}
		input {
			width: 70%;
			margin: 1%;
		}
		#copy {
		}
		#settings {
			width: 49vw;
			float: left;
			user-select: none;
		}
		pre {
			float: left;
			width: 100%;
		}
		select {
			margin: 1%;
		}
		@media screen and (orientation:portrait) {
			body {
				font-size: 2vmax;
			}
			canvas {
				width: 100%;
			}
			#settings {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<canvas width="1000" height="500"></canvas>

	<div id="settings">
		<select id="pt-editor-channel" onchange="setEditor()">
			<option>main channel</option>
			<option>additional</option>
			<option>extra</option>
			<option>reserved</option>
			<option>emergency</option>
		</select><a href="https://github.com/alexanderbrodko/expl/">github</a><br />
		<input type="range" id="pt-editor-pause" min="0" max="1" step="0.05" value="0" /> pause<br />
		<input type="range" id="pt-editor-count" min="0" max="50" step="1" /> count<br />
		<input type="range" id="pt-editor-spread" min="0" max="1" step="0.05" value="0.35" /> spread<br />
		<input type="range" id="pt-editor-area" min="0" max="0.5" step="0.01" value="0.02" /> spawn area<br />
		<input type="range" id="pt-editor-dx" min="-1" max="1" step="0.05" value="0" /> expl x dir<br />
		<input type="range" id="pt-editor-dy" min="-1" max="1" step="0.05" value="1" /> expl y dir<br />
		<input type="range" id="pt-editor-homogenity" min="0.0" max="1" step="0.05" value="0.45" /> homogenity<br />
		<input type="range" id="pt-editor-physical" min="0" max="1" step="0.05" value="1" /> physical<br />
		<input type="range" id="pt-editor-gravity" min="-1" max="1" step="0.05" value="-0.9" /> gravity<br />
		<input type="range" id="pt-editor-ttl" min="0.1" max="1" step="0.05" value="0.25" /> ttl<br />
		<input type="range" id="pt-editor-custom" min="1" max="255" step="1" value="5" /> preview size<br />
	</div>

	<script type="text/javascript">
		let editorDx = document.getElementById('pt-editor-dx'),
			editorDy = document.getElementById('pt-editor-dy'),
			editorCount = document.getElementById('pt-editor-count'),
			editorSpread = document.getElementById('pt-editor-spread'),
			editorArea = document.getElementById('pt-editor-area'),
			editorGravity = document.getElementById('pt-editor-gravity'),
			editorTtl = document.getElementById('pt-editor-ttl'),
			editorHomogenity = document.getElementById('pt-editor-homogenity'),
			editorPhysical = document.getElementById('pt-editor-physical'),
			editorCustom = document.getElementById('pt-editor-custom'),
			editorPause = document.getElementById('pt-editor-pause'),
			editorChannel = document.getElementById('pt-editor-channel');

		let expl = new Explosions(),
			canvas = document.querySelector('canvas'),
			ctx = canvas.getContext('2d'),
			cwidth = canvas.width,
			cheight = canvas.height,
			vmax = Math.max(cwidth, cheight),
			channels = [];

		let url = window.location.href,
			urlParamsMarker = url.lastIndexOf('?');
		if (urlParamsMarker > 0) {
			let urlParams = url.substring(urlParamsMarker + 1);

			channels = urlParams.split(',');

			setEditor();
		} else {
			urlParamsMarker = url.length;
		}

		function getEditor() {
			return expl.toBase64({
				pause: parseFloat(editorPause.value),
				dx: parseFloat(editorDx.value),
				dy: parseFloat(editorDy.value),
				count: parseFloat(editorCount.value),
				spread: parseFloat(editorSpread.value),
				area: parseFloat(editorArea.value),
				gravity: parseFloat(editorGravity.value),
				ttl: parseFloat(editorTtl.value),
				homogenity: parseFloat(editorHomogenity.value),
				physical: parseFloat(editorPhysical.value),
				custom: parseFloat(editorCustom.value)
			});
		}

		function setEditor() {
			let str = channels[editorChannel.selectedIndex];
			if (!str) return;

			let obj = expl.fromBase64(str);

			editorPause.value = obj.pause;
			editorDx.value = obj.dx;
			editorDy.value = obj.dy;
			editorCount.value = obj.count;
			editorSpread.value = obj.spread;
			editorArea.value = obj.area;
			editorGravity.value = obj.gravity;
			editorTtl.value = obj.ttl;
			editorHomogenity.value = obj.homogenity;
			editorPhysical.value = obj.physical;
			editorCustom.value = obj.custom;

			editorPause.title = obj.pause.toFixed(3);
			editorDx.title = obj.dx.toFixed(3);
			editorDy.title = obj.dy.toFixed(3);
			editorCount.title = obj.count;
			editorSpread.title = obj.spread.toFixed(3);
			editorArea.title = obj.area.toFixed(3);
			editorGravity.title = obj.gravity.toFixed(3);
			editorTtl.title = obj.ttl.toFixed(3);
			editorHomogenity.title = obj.homogenity.toFixed(3);
			editorPhysical.title = obj.physical.toFixed(3);
			editorCustom.title = obj.custom;
		}

		function drawPts(dt) {

			canvas.width = canvas.width; // clear
			ctx.globalCompositeOperation = 'lighter'; // additive blend; so no need to use globalAlpha

			for (let e of expl) if (e.t > 0) {
				let opacity = Math.sin(e.t / e.ttl * Math.PI), // 0 at start, 1 in the middle and 0 at end
					size = e.custom * (1 + opacity) * e.weight, // more opacity means bigger
					hue = Math.floor(e.rnd * 10 + e.custom * Math.PI * Math.PI) % 360;

				ctx.fillStyle = `hsl(${hue} 100% ${opacity * 50}%)`;
				ctx.fillRect(cwidth / 2 + e.x * vmax / 2 - size / 2, cheight / 2 - e.y * vmax / 2 - size / 2, size, size);
			}
		}

		let prevUpdateTime = Date.now();

		function update(timestamp) {
			requestAnimationFrame(update);

			if (!window.document.hasFocus()) return;

			prevUpdateTime = prevUpdateTime || timestamp;
			let dt = (timestamp - prevUpdateTime) * 0.001;

			expl.update(dt);
			drawPts();

			prevUpdateTime = timestamp;
		}
		update();

		function runFx() {
			if (!window.document.hasFocus()) return;

			if (editorCount.value > 0) {
				let str = getEditor();
				channels[editorChannel.selectedIndex] = str;
			} else {
				channels[editorChannel.selectedIndex] = '';
			}

			for (let str of channels) {
				if (str) {
					expl.add(0, 0, expl.fromBase64(str));
				}
			}

			setEditor();
			
			let newUrl = url.substr(0, urlParamsMarker) + '?' + channels.join(',');
			window.history.replaceState({}, null, newUrl);
		}

		setInterval(runFx, 1000);

	</script>
</body>

</html>
